# Cloudflare画像生成スクリプト 改善版

## 改善内容

### 1. **レスポンスタイプの判定**
- Content-Typeヘッダーをチェック
- 画像バイナリとJSONエラーレスポンスを正確に区別
- レスポンスサイズによる自動判定（10KB以上は画像）

### 2. **レート制限対応（429エラー）**
- `Retry-After`ヘッダーを自動検出
- 適切な待機時間で自動リトライ
- 最大待機時間制限（60秒）

### 3. **指数バックオフでのリトライ**
- 初期待機: 2秒
- 指数的に増加: 2秒 → 4秒 → 8秒
- 最大リトライ回数: 3回
- タイムアウトエラーにも対応

### 4. **連続リクエスト対策**
- スライド間に3秒の待機時間
- レート制限を回避
- 処理時間の表示

### 5. **詳細なエラーログ**
- ステータスコード別の処理
- JSONエラーレスポンスの整形表示
- スタックトレースの出力
- 失敗したスライド番号の記録

### 6. **タイムアウト調整**
- 60秒 → 90秒に延長
- より安定した画像生成

## 使用方法

### 1. 環境変数の設定

```bash
# Cloudflare API認証情報を設定
export CLOUDFLARE_API_TOKEN='your-cloudflare-api-token'
export CLOUDFLARE_ACCOUNT_ID='your-cloudflare-account-id'
```

### 2. テスト実行

```bash
# 接続テスト（小さめの画像で確認）
python3 ~/Desktop/claude/scripts/test_cloudflare.py
```

### 3. 本番実行

```bash
# スライド画像の一括生成
python3 ~/Desktop/claude/scripts/generate_images_cloudflare.py \
  ~/robby_content/post_001/slide_prompts.json \
  ~/robby_content/post_001/images/
```

## エラー対処法

### ❌ 環境変数未設定
```
エラー: 環境変数が設定されていません
```
**対処**: 上記の環境変数設定を実行

### ⏳ レート制限（429）
```
レート制限検知（429）- XX秒待機...
```
**対処**: 自動でリトライされます。待機してください。

### ⏰ タイムアウト
```
タイムアウト（90秒）
```
**対処**:
- ネットワーク接続を確認
- 画像サイズを小さくする（width/heightを調整）
- 自動でリトライされます

### ⚠️ サーバーエラー（5xx）
```
サーバーエラー（500）- XX秒後にリトライ...
```
**対処**: Cloudflare側の一時的な問題。自動でリトライされます。

### ❌ 認証エラー（401/403）
```
APIエラー: 401
```
**対処**:
- API_TOKENが正しいか確認
- ACCOUNT_IDが正しいか確認
- Cloudflareダッシュボードで権限を確認

## 設定のカスタマイズ

スクリプトの以下の定数を変更できます：

```python
# リトライ設定
MAX_RETRIES = 3              # 最大リトライ回数
INITIAL_RETRY_DELAY = 2      # 初期待機時間（秒）
MAX_RETRY_DELAY = 60         # 最大待機時間（秒）
REQUEST_INTERVAL = 3         # スライド間待機時間（秒）
```

## 実行例

```bash
# 成功例
🎨 画像生成中...
   試行 1/3
✅ 画像生成成功（371.2 KB）
📝 テキストオーバーレイ追加中...
✅ 保存完了: slide_01.png

# レート制限例
🎨 画像生成中...
   試行 1/3
⏳ レート制限検知（429）- 5秒待機...
   試行 2/3
✅ 画像生成成功（371.2 KB）

# リトライ成功例
🎨 画像生成中...
   試行 1/3
⚠️  サーバーエラー（503）- 2秒後にリトライ...
   試行 2/3
✅ 画像生成成功（371.2 KB）
```

## トラブルシューティング

### エラーループに陥った場合

1. **Ctrl+C で停止**
2. **環境変数を確認**
   ```bash
   echo $CLOUDFLARE_API_TOKEN
   echo $CLOUDFLARE_ACCOUNT_ID
   ```
3. **テストスクリプトで動作確認**
   ```bash
   python3 test_cloudflare.py
   ```
4. **待機時間を増やす**
   ```python
   REQUEST_INTERVAL = 5  # 3→5秒に変更
   ```

### 処理時間の目安

- 1枚あたり: 5-15秒（画像生成）+ 1秒（テキスト処理）
- 6枚のスライド: 約60-120秒（待機時間含む）
- レート制限時: +5-60秒/リトライ

## 注意事項

- **必ず環境変数を設定してから実行**してください
- レート制限に注意（連続実行を避ける）
- 大量の画像を生成する場合は、バッチに分ける
- エラーが続く場合は、Cloudflareのステータスページを確認

## ログの見方

- 🎨 画像生成開始
- ✅ 成功
- ❌ 失敗（致命的エラー）
- ⚠️  警告（リトライ可能なエラー）
- ⏳ 待機中
- ⏰ タイムアウト
- 📝 テキスト処理
- 🎉 全て完了
